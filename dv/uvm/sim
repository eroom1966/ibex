# Copyright lowRISC contributors.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

# Script to run the assembly tests generated by the riscv-dv instruction generator.
#set -x

# Test directory
RUN_DIR="./"

# Assembly test file name
TEST=""

# Seed
RAND_SEED=1
SEED=""

# Wavform dump options
WAVES=0
WAVES_OPTS=""

# Process command line options
while [[ $# -gt 0 ]]
do
key="$1"
case $key in
    -dir)
    RUN_DIR="$2"
    shift
    ;;
    -tool)
    SIMULATOR="$2"
    shift
    ;;
    -test)
    TEST="$2"
    shift
    ;;
    -waves)
    WAVES="$2"
    shift
    ;;
    -seed)
    SEED="$2"
    RAND_SEED=0
    shift
    ;;
    *)
    echo "unknown option $1"
    return
    ;;
esac
shift
done

function run_vcs () {
    $OUT/vcs_simv +UVM_TESTNAME=core_ibex_base_test \
       ${WAVES_OPTS} \
       -l sim.log 
       +ntb_random_seed=${SEED} \
       +bin=$BINFILE
}

function run_questa () {
    if [ -L work ]; then
        rm work
    fi
    UVMDIR=$(dirname ${RUN_DIR})
    ln -s ${UVMDIR}/work .

    vsim core_ibex_tb_top -msglimit all \
       -msglimitcount 2 -c -do ${UVMDIR}/sim.do \
       -L ${QUESTA_HOME}/uvm-1.2 +UVM_TESTNAME=core_ibex_base_test \
       -l sim.log -sv_seed $SEED +bin=$BINFILE
}


# If the test is specified through "-test" option, run a single test rather
# than all tests under RUN_DIR.
if [[ $TEST == "" ]]; then
  find "$RUN_DIR" -name "*.S" > "$RUN_DIR/asm_test_list"
else
  echo "$TEST" > "$RUN_DIR/asm_test_list"
fi

OUT="$RUN_DIR/rtl_sim"

# Run each test
while read asm_test; do
  SRC=$(echo "$asm_test" | sed 's/^.*\///g' | sed 's/\.S>*$//g')
  BINFILE="$asm_test.bin"
  mkdir -p $OUT/$SRC
  cd $OUT/$SRC
  
  if [[ $RAND_SEED == 1 ]]; then
    SEED=$RANDOM
  fi
  if [[ $WAVES == 1 ]]; then
    WAVES_OPTS="-ucli -do $RUN_DIR/../vcs.tcl"
  fi
  
  if [[ "$SIMULATOR" == "vcs" ]]; then
    run_vcs
  elif [[ "$SIMULATOR" == "questa" ]]; then
    run_questa
  else
    echo "unsupported simulator $SIMULATOR"
    exit -1
  fi
done <"$RUN_DIR/asm_test_list"
